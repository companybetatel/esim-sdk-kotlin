name: Publish to Maven Central

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.0.1, etc.
  workflow_dispatch:  # Allows manual trigger

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: production  # Optional: use GitHub environment for additional protection

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Extract version from tag
      id: get_version
      run: |
        # Extract version from tag (e.g., v1.0.1 -> 1.0.1)
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Publishing version: $VERSION"

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build and test
      run: ./gradlew clean build test -PprojVersion=${{ steps.get_version.outputs.VERSION }} --no-daemon --stacktrace

    - name: Verify secrets are configured
      run: |
        if [ -z "${{ secrets.CENTRAL_USERNAME }}" ]; then
          echo "‚ùå ERROR: CENTRAL_USERNAME secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.CENTRAL_PASSWORD }}" ]; then
          echo "‚ùå ERROR: CENTRAL_PASSWORD secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.SIGNING_KEY }}" ]; then
          echo "‚ùå ERROR: SIGNING_KEY secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.SIGNING_PASSWORD }}" ]; then
          echo "‚ùå ERROR: SIGNING_PASSWORD secret is not set"
          exit 1
        fi
        echo "‚úÖ All required secrets are configured"

    - name: Publish to Maven Central Portal
      env:
        CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
        CENTRAL_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}
        SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
      run: |
        echo "Publishing to Maven Central Portal..."
        echo "Version: ${{ steps.get_version.outputs.VERSION }}"
        echo "Username: ${CENTRAL_USERNAME:0:3}***"
        echo "Using repository: https://central.sonatype.com/api/v1/publisher/upload"
        ./gradlew publishMavenPublicationToCentralPortalRepository -PprojVersion=${{ steps.get_version.outputs.VERSION }} --no-daemon --stacktrace --info

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/libs/esim-sdk-kotlin-*.jar
        body: |
          ## Release ${{ steps.get_version.outputs.VERSION }}

          Published to Maven Central:
          ```gradle
          implementation 'com.betatel.esim:esim-sdk-kotlin:${{ steps.get_version.outputs.VERSION }}'
          ```

          ### Artifacts
          - Main JAR: `esim-sdk-kotlin-${{ steps.get_version.outputs.VERSION }}.jar`
          - Sources JAR: `esim-sdk-kotlin-${{ steps.get_version.outputs.VERSION }}-sources.jar`
          - Javadoc JAR: `esim-sdk-kotlin-${{ steps.get_version.outputs.VERSION }}-javadoc.jar`

          ### Installation
          Add to your `build.gradle`:
          ```gradle
          repositories {
              mavenCentral()
          }

          dependencies {
              implementation 'com.betatel.esim:esim-sdk-kotlin:${{ steps.get_version.outputs.VERSION }}'
          }
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify on success
      if: success()
      run: |
        echo "‚úÖ Successfully published version ${{ steps.get_version.outputs.VERSION }} to Maven Central"
        echo "üéâ GitHub Release created at: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"

    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Failed to publish version ${{ steps.get_version.outputs.VERSION }}"
        echo "Please check the logs above for details"
        exit 1
